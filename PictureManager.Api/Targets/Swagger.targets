<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="15.0">

  <PropertyGroup Label="SwaggerProps">
    <SwaggerBuildDir>AutoGeneratedFilesBySwagger</SwaggerBuildDir>
  </PropertyGroup>

  <Target Name="GenerateSwaggerSpec" AfterTargets="Publish"
          Condition= "$(ExeGenSwag) == 'True' and $(PublishDir) != ''">
    <Message Text="### Executing Swashbuckle Swagger Spec. Generation over $(OutputPath)$(AssemblyName).dll ###" Importance="High" />
    <MakeDir Directories="$(SwaggerBuildDir)\" Condition="!Exists('$(OutputPath)\\$(SwaggerBuildDir)')" />
    <Exec Command="dotnet swagger tofile --output $(SwaggerBuildDir)\\$(AssemblyName).swagger.json $(OutputPath)$(AssemblyName).dll v1.0" />
    <Error Condition="Exists($(AssemblyName))" Text="The assembly file could not be found, please publish the version before generating client" />
  </Target>

  <Target Name="GenerateApiClients" AfterTargets="GenerateSwaggerSpec" DependsOnTargets="GenerateSwaggerSpec"
        Condition= "$(ExeGenSwag) == 'True' and $(PublishDir) != ''">
    <Message Text="### Executing NSwag Api Clients Generation ###" Importance="High" />
    <Error Condition="Exists($(AssemblyName))" Text="The assembly file could not be found, please publish the version before generating client" />
    <Exec Command="$(NSwagExe_Core20) swagger2csclient /input:$(SwaggerBuildDir)\$(AssemblyName).swagger.json /namespace:PictureManager.Api.Client.SwaggerClient /InjectHttpClient:true /className:BasketManagerClient /ClientBaseClass:SwaggerBaseClient /UseHttpRequestMessageCreationMethod:true /output:$(SwaggerBuildDir)\\BasketManagerClient.cs"/>
  </Target>

  <ItemGroup>
    <ItemsToCopy Include="$(SwaggerBuildDir)\*.cs*" />
  </ItemGroup>

  <Target Name="CopyGeneratedCsClients" AfterTargets="Build" DependsOnTargets="GenerateApiClients"
      Condition="$(GenerateClientsOnBuild) == 'True'">
    <Message Importance="high" Text="### Copying generated clients to $(SwaggerClientsDir)"></Message>
    <Copy SourceFiles="@(ItemsToCopy)" DestinationFolder="$(SwaggerClientsDir)" OverwriteReadOnlyFiles="true" />
  </Target>

</Project>